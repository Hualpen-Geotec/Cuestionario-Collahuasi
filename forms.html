<script>
  document.addEventListener("DOMContentLoaded", () => {
    const PREGUNTAS_URL = "https://script.google.com/macros/s/AKfycbwpZHA5cfKCoyvFBfeeZAPUZ4SqMX3MhmpcdkPPhNrk0gFwpBoewz5Y8VoWFsZNs2qM/exec";
    const ENVIO_URL = "https://script.google.com/macros/s/AKfycbxbGCPrz9NOkROOFOT1ffkwGskzRngk7R4UEIBMq3-vzuEbq0K_B6QMnV9Q7NafgvwBZA/exec";

    const rut = localStorage.getItem("rut");
    const nombre = localStorage.getItem("nombre");
    const correo = localStorage.getItem("correo");

    if (!rut || !nombre || !correo) {
      alert("Debes ingresar desde la pÃ¡gina principal.");
      window.location.href = "index.html";
      return;
    }

    const formulario = document.getElementById("formularioPreguntas");

    fetch(PREGUNTAS_URL)
      .then(res => res.json())
      .then(preguntas => mostrarPreguntas(preguntas))
      .catch(err => {
        formulario.innerHTML = "<p style='color: red;'>Error cargando preguntas.</p>";
        console.error(err);
      });

    function mostrarPreguntas(preguntas) {
      if (!preguntas || preguntas.length === 0) {
        formulario.innerHTML = "<p style='color: red;'>No se pudieron cargar preguntas.</p>";
        return;
      }

      preguntas.forEach((p, i) => {
        const div = document.createElement("div");
        div.className = "pregunta";
        div.innerHTML = `
          <p><strong>${i + 1}. ${p.pregunta}</strong></p>
          ${p.alternativas.map((alt, idx) => `
            <label>
              <input type="radio" name="pregunta${i}" value="${alt}" required />
              ${String.fromCharCode(65 + idx)}. ${alt}
            </label>
          `).join("")}
        `;
        formulario.appendChild(div);
      });

      const boton = document.createElement("button");
      boton.type = "submit";
      boton.textContent = "Ver Resultados";
      formulario.appendChild(boton);

      formulario.addEventListener("submit", e => procesarRespuestas(e, preguntas));
    }

    function procesarRespuestas(e, preguntas) {
      e.preventDefault();
      let correctas = 0;
      const erroresPorFuente = {};

      preguntas.forEach((p, i) => {
        const respuesta = document.querySelector(`input[name="pregunta${i}"]:checked`).value;
        const esCorrecta = respuesta === p.correcta;

        if (esCorrecta) {
          correctas++;
        } else {
          erroresPorFuente[p.fuente] = (erroresPorFuente[p.fuente] || 0) + 1;
        }

        document.getElementsByName(`pregunta${i}`).forEach(r => {
          r.disabled = true;
          if (r.value === p.correcta) r.parentElement.style.color = "green";
          if (r.value === respuesta && respuesta !== p.correcta) r.parentElement.style.color = "red";
        });
      });

      const porcentaje = Math.round((correctas / preguntas.length) * 100);
      document.getElementById("porcentaje").textContent = `Tu puntaje es: ${porcentaje}%`;

      const resumen = Object.entries(erroresPorFuente).map(
        ([clave, valor]) => `<p>${clave}: ${valor} errores</p>`
      ).join("");
      document.getElementById("resumenErrores").innerHTML = resumen;

      fetch(ENVIO_URL, {
        method: "POST",
        body: JSON.stringify({ rut, nombre, correo, nota: porcentaje, errores: erroresPorFuente }),
        headers: { "Content-Type": "application/json" }
      }).catch(err => {
        alert("Error al guardar los resultados.");
        console.error(err);
      });

      document.getElementById("resultados").style.display = "block";
    }

    document.getElementById("nuevoIntento").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "index.html";
    });
  });
</script>


